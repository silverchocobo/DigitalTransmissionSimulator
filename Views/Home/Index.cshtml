@{
    ViewData["Title"] = "Home Page";
}

@model TransmissionSimulator.Models.Transmission

<div class="text-center">
    <h1 class="display-4">Simulador de Transmissão Digital</h1>
</div>

@using(Html.BeginForm("Index", "Home", FormMethod.Post, new {@id = "dataForm", @class= "form-horizontal"}))
{
<form>
    <label>Mensagem</label>
    @Html.TextBoxFor(m => m.Message, new { @class = "form-control", placeholder = "Insira sua mensagem", id = "messageInput" })
    <br>

     <div class="form-group mb-3">
        <label asp-for="NoiseLevel" class="form-label">Nível de Ruído (σ): <span id="noiseValue">@Model.NoiseLevel</span></label>
        <input asp-for="NoiseLevel" type="range" class="form-range" min="0" max="50" step="0.1"
               oninput="document.getElementById('noiseValue').textContent = this.value">
    </div>

    <div class="form-group mb-3">
        <label asp-for="Amplitude" class="form-label">Amplitude (V): <span id="amplitude">@Model.Amplitude</span></label>
        <input asp-for="Amplitude" type="range" class="form-range" min="0" max="20" step="1"
               oninput="document.getElementById('amplitude').textContent = this.value">
    </div>

    <div class="form-check">
        <input type="radio" id="ami" name="EncodingType" value="ami" checked = "@(Model.EncodingType == "ami" ? "checked" : null)">
        <label class="form-check-label" for="ami">Codificação AMI / Modulação de Amplitude</label>
    </div>
    
    <div class = "form-check">
        <input type="radio" id="bpsk" name="EncodingType" value="bpsk" checked = "@(Model.EncodingType == "bpsk" ? "checked" : null)">
        <label class="form-check-label" for="bpsk">Codificação NRZ Polar / Modulação BPSK</label>
    </div>

    <button id = "submitButton" class="btn btn-primary mt-4" type="submit">Transmitir</button>
</form>
}

@if (Model != null)
    {
        <div class="alert alert-light text-center mt-4">

        @if (Model.EncodingType == "ami")
        {
            <div>
                <h5 style="word-wrap: break-word">ASCII para bits: @Model.Binary</h5>
                <hr />
            </div>

            <div>
                <h5>SNR (dB): @Model.SNR</h5>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <h5>Codificação AMI Bipolar</h5>
                    <canvas id="amiChart"></canvas>
                </div>
                <div class="col-md-6">
                    <h5>Sinal Modulado (AMI)</h5>
                    <canvas id="signalChart"></canvas>
                </div>
            </div>

            <div class="mt-3">
                <h3>Mensagem Decodificada:</h3>
                <h4 class="font-monospace text-success bg-dark p-2 rounded">
                    @Model.DecodedMessage
                </h4>
            </div>

            <div class="mt-4 p-3 bg-secondary text-white rounded">
                <h5>Transmissão AMI:</h5>
                <div class="text-monospace">
                    <p class="mb-0"><strong>AMI Original:</strong> @Model.AmiCode</p>
                    <p class="mb-0"><strong>AMI Recebido:</strong> @Model.RecoveredAmi</p>
                    <hr style="border-top: 1px solid white;" />
                    <p class="mb-0"><strong>Código Binário Original:</strong> @Model.Binary</p>
                    <p class="mb-0"><strong>Código Binário Recebido:</strong> @Model.RecoveredBinary</p>
                </div>
                <h5>Diferença de bits: @Model.Difference</h5>
            </div>
        }

        @if (Model.EncodingType == "bpsk")
        {   
            <h4>ASCII para bits: @Model.Binary</h4>
            <hr />
            <div class="row">
                <div class="col-md-6">
                    <h5>Codificação NRZ Polar</h5>
                    <canvas id="nrzChart"></canvas>
                </div>
                <div class="col-md-6">
                    <h5>Sinal Modulado (BPSK)</h5>
                    <canvas id="bpskChart"></canvas>
                </div>
            </div>

            <div class="mt-3">
                <h3>Mensagem Decodificada (BPSK):</h3>
                <h4 class="font-monospace text-primary bg-dark p-2 rounded">
                    @Model.DecodedMessageBpsk
                </h4>
            </div>

            <div class="mt-4 p-3 bg-secondary text-white rounded">
                <h5>Transmissão BPSK:</h5>
                <div class="text-monospace">
                    <p class="mb-0"><strong>Código Binário Original:</strong> @Model.Binary</p>
                    <p class="mb-0"><strong>Código Binário Recebido (BPSK):</strong> @Model.RecoveredBinaryBpsk</p>
                </div>
                <h5>Diferença de bits: @Model.Difference</h5>
            </div>
        } 

    </div>
    }

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const messageInput = document.getElementById('messageInput');
            const submitButton = document.getElementById('submitButton');

            function validateInput() {
                if (messageInput.value.trim().length > 0) {
                    submitButton.disabled = false;
                } else {
                    submitButton.disabled = true;
                }
            }
            messageInput.addEventListener('input', validateInput);
            validateInput();
        });
    </script>

    @if (Model != null && Model.Binary != null)
    {
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    }

    @if (Model.EncodingType == "ami" && Model.AmiModulatedSignalDouble != null)
    {
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                try {
                    const binaryLabels = @Html.Raw(Json.Serialize(Model.Binary.ToCharArray()));
                    const amiData = @Html.Raw(Json.Serialize(Model.AmiCodeInt));
                    const signalData = @Html.Raw(Json.Serialize(Model.AmiModulatedSignalDouble));
                    const dataToShow = signalData.slice(0, 400);
                    const signalLabels = Array.from({ length: dataToShow.length }, (_, i) => i);

                    const amiCtx = document.getElementById('amiChart').getContext('2d');
                    new Chart(amiCtx, {
                        type: 'line',
                        data: {
                            labels: binaryLabels,
                            datasets: [{
                                label: 'Polaridade AMI',
                                data: amiData,
                                borderColor: 'rgb(0, 123, 255)',
                                borderWidth: 2,
                                stepped: 'before',
                                pointRadius: 0
                            }]
                        },
                        options: {
                            scales: {
                                x: { title: { display: true, text: 'Bits da Mensagem' } },
                                y: {
                                    title: { display: true, text: 'Nível' },
                                    ticks: { stepSize: 1 },
                                    min: -1.5,
                                    max: 1.5
                                }
                            }
                        }
                    });

                    const signalCtx = document.getElementById('signalChart').getContext('2d');
                    new Chart(signalCtx, {
                        type: 'line',
                        data: {
                            labels: signalLabels,
                            datasets: [{
                                label: 'Amplitude do Sinal Modulado',
                                data: dataToShow,
                                borderColor: 'rgb(220, 53, 69)',
                                borderWidth: 1.5,
                                pointRadius: 0
                            }]
                        },
                        options: {
                            scales: {
                                x: { title: { display: true, text: 'Amostras' } },
                                y: { title: { display: true, text: 'Amplitude' } }
                            }
                        }
                    });
                } catch (e) {
                    console.error("Erro ao renderizar os gráficos AMI:", e);
                }
            });
        </script>
    }

    @if (Model.EncodingType == "bpsk" && Model.BpskSignal != null)
    {
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                try {
                    const binaryLabels = @Html.Raw(Json.Serialize(Model.Binary.ToCharArray()));
                    const nrzData = @Html.Raw(Json.Serialize(Model.NRZCode));
                    const bpskSignalData = @Html.Raw(Json.Serialize(Model.BpskSignal));
                    const dataToShow = bpskSignalData.slice(0, 400);
                    const bpskLabels = Array.from({ length: dataToShow.length }, (_, i) => i);

                    const nrzCtx = document.getElementById('nrzChart').getContext('2d');
                    new Chart(nrzCtx, {
                        type: 'line',
                        data: {
                            labels: binaryLabels,
                            datasets: [{
                                label: 'Nível NRZ-Polar',
                                data: nrzData,
                                borderColor: 'rgb(25, 135, 84)',
                                borderWidth: 2,
                                stepped: 'before',
                                pointRadius: 0
                            }]
                        },
                        options: {
                            scales: {
                                x: { title: { display: true, text: 'Bits da Mensagem' } },
                                y: {
                                    title: { display: true, text: 'Nível' },
                                    ticks: { stepSize: 1 },
                                    min: -1.5,
                                    max: 1.5
                                }
                            }
                        }
                    });

                    const bpskCtx = document.getElementById('bpskChart').getContext('2d');
                    new Chart(bpskCtx, {
                        type: 'line',
                        data: {
                            labels: bpskLabels,
                            datasets: [{
                                label: 'Amplitude do Sinal BPSK',
                                data: dataToShow,
                                borderColor: 'rgb(13, 110, 253)',
                                borderWidth: 1.5,
                                pointRadius: 0
                            }]
                        },
                        options: {
                            scales: {
                                x: { title: { display: true, text: 'Amostras' } },
                                y: { title: { display: true, text: 'Amplitude' } }
                            }
                        }
                    });
                } catch (e) {
                    console.error("Erro ao renderizar os gráficos BPSK:", e);
                }
            });
        </script>
    }
}
