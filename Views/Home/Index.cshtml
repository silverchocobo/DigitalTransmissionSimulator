@{
    ViewData["Title"] = "Home Page";
}

@model TransmissionSimulator.Models.Transmission

<div class="text-center">
    <h1 class="display-4">Simulador de Transmissão</h1>
</div>

@using(Html.BeginForm("Index", "Home", FormMethod.Post, new {@id = "dataForm", @class= "form-horizontal"}))
{
<form>
    <label>Mensagem</label>
    @Html.TextBoxFor(m => m.Message, new { @class = "form-control", placeholder = "Enter your message", id = "messageInput" })

     <div class="form-group mb-3">
        <label asp-for="NoiseLevel" class="form-label">Nível de Ruído (σ): <span id="noiseValue">@Model.NoiseLevel</span></label>
        <input asp-for="NoiseLevel" type="range" class="form-range" min="0" max="2" step="0.1"
               oninput="document.getElementById('noiseValue').textContent = this.value">
    </div>

    <button id = "submitButton" class="btn btn-primary mt-4" type="submit">Transmitir</button>
</form>
}

@if (Model != null)
    {
        <div class="alert alert-success text-center mt-4">
            <h4>ASCII para bits: @Model.Binary</h4>
            @* <h4>Codificação AMI Bipolar: @Model.AmiCode</h4> *@
            @* <h4>Modulated Ami: @Model.AmiModulatedSignal</h4> *@
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Codificação AMI Bipolar</h5>
                            <canvas id="amiChart"></canvas>
                        </div>
                    <div class="col-md-6">
                        <h5>Sinal Modulado</h5>
                        <canvas id="signalChart"></canvas>
                    </div>
                </div>
            <div class="mt-3">
                <h3>Mensagem Decodificada:</h3>
                <h4 class="alert alert-success text-center mt-4">
                    @Model.DecodedMessage
                </h4>
            </div>
             <div class="mt-4 p-3 bg-secondary text-white rounded">
            <h5>Debug Information:</h5>
            <div class="text-monospace">
                <p class="mb-0"><strong>Original AMI:</strong> @Model.AmiCode</p>
                <p class="mb-0"><strong>Recovered AMI:</strong> @Model.Debug_RecoveredAmi</p>
                <hr style="border-top: 1px solid white;"/>
                <p class="mb-0"><strong>Original Binary:</strong> @Model.Binary</p>
                <p class="mb-0"><strong>Recovered Binary:</strong> @Model.Debug_RecoveredBinary</p>
            </div>
        </div>
        </div>
                
    }

@* 
This section adds scripts to the page. 
It will be rendered by the @RenderSection("Scripts", required: false) in your _Layout.cshtml file.
*@
@section Scripts {

     <script>
        document.addEventListener("DOMContentLoaded", function () {
            // --- Get references to the input field and the button ---
            const messageInput = document.getElementById('messageInput');
            const submitButton = document.getElementById('submitButton');

            // --- Function to check the input and toggle the button's state ---
            function validateInput() {
                // Trim removes whitespace from the beginning and end.
                // If the input is empty or only contains spaces, disable the button.
                if (messageInput.value.trim().length > 0) {
                    submitButton.disabled = false;
                } else {
                    submitButton.disabled = true;
                }
            }

            // --- Listen for input events on the message box ---
            // The 'input' event fires every time the content changes (typing, pasting, etc.)
            messageInput.addEventListener('input', validateInput);

            // --- Run the validation once on page load ---
            // This handles cases where the page reloads with a pre-filled (or empty) value.
            validateInput();
        });
    </script>

    <!-- 1. Include the Chart.js library from a CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    @* Only run the chart script if the signal data exists *@
    @if (Model?.AmiModulatedSignal != null && Model.AmiModulatedSignal.Length > 0)
    {
        <script>
            try {
            // Wait until the page content is fully loaded before running the script
            document.addEventListener("DOMContentLoaded", function () {

                const binaryLabels = @Html.Raw(Json.Serialize(Model.Binary));
                const amiData = @Html.Raw(Json.Serialize(Model.AmiCodeInt));
                const signalData = @Html.Raw(Json.Serialize(Model.AmiModulatedSignalDouble));
                
                // 3. Parse the JSON data from the server into a JavaScript array
                
                // For performance and readability, let's only plot the first 400 samples
                const dataToShow = signalData.slice(325, 400); 
                
                // Create labels for the x-axis (0, 1, 2, 3...)
                const labels = Array.from(Array(dataToShow.length).keys());

                const signalCtx = document.getElementById('signalChart').getContext('2d');

                // Gráfico codificação AMI
                const amiCtx = document.getElementById('amiChart').getContext('d');
                new Chart(amiChart, {
                    type: 'line', // We want a line chart
                    data: {
                        labels: binaryLabels,
                        datasets: [{
                            label: 'Bits Codificados',
                            data: amiData,
                            borderColor: 'rgb(75, 192, 192)',
                            borderWidth: 1.5,
                            pointRadius: 0, // Hides the dots on the line for a cleaner look
                            stepped: 'before'
                        }]
                    },
                    options: {
                        animation: {
                            duration: 0 // Disable animation for faster rendering
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Bits' }
                            },
                            y: {
                                title: { display: true, text: 'Polaridade' },
                                min: 1, // Set a fixed Y-axis to prevent jumping
                                max: -1   // Should be slightly larger than your amplitude
                            }
                        }
                    }
                });
                
                // 4. Gráfico modulação
                new Chart(signalCtx, {
                    type: 'line', // We want a line chart
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Amplitude do sinal modulado',
                            data: dataToShow,
                            borderColor: 'rgb(75, 192, 192)',
                            borderWidth: 1.5,
                            pointRadius: 0, // Hides the dots on the line for a cleaner look
                            tension: 0.1    // Makes the line slightly curved
                        }]
                    },
                    options: {
                        animation: {
                            duration: 0 // Disable animation for faster rendering
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Amostras' }
                            },
                            y: {
                                title: { display: true, text: 'Amplitude' },
                                min: -7, // Set a fixed Y-axis to prevent jumping
                                max: 7   // Should be slightly larger than your amplitude
                            }
                        }
                    }
                });
            });
        } catch (e) {
                // If any error happens, it will be logged here.
                console.error("Erro de renderização da tabela:", e);
            }
        </script>
    }
}